openapi: 3.1.0
info:
  title: ReadZone Admin API
  description: |
    관리자 전용 API - 사용자 관리 및 시스템 관리

    **Features**:
    - 사용자 조회 및 관리
    - 역할 변경 (RBAC)
    - 계정 정지 및 복구
    - Audit log 조회

    **Authorization**: Admin 역할 필수 (role = 'admin')

    **Rate Limiting**: 1000회/시간 (관리자 기준)
  version: 1.0.0
  contact:
    name: ReadZone API Support
    email: api@readzone.com

servers:
  - url: http://localhost:3000/api/v1
    description: Development server
  - url: https://api.readzone.com/v1
    description: Production server

tags:
  - name: admin-users
    description: 사용자 관리
  - name: admin-audit
    description: Audit log 관리

security:
  - cookieAuth: []

paths:
  # ============================================================
  # 사용자 관리
  # ============================================================

  /admin/users:
    get:
      tags:
        - admin-users
      summary: 사용자 목록 조회
      description: |
        전체 사용자를 조회합니다 (페이지네이션).

        **Query Options**:
        - 역할 필터 (role)
        - 상태 필터 (status)
        - 이메일 검색 (search)
        - 정렬 (sortBy, sortOrder)

        **Returns**: 사용자 목록 + 페이지네이션 메타데이터
      operationId: listUsers
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: 페이지 번호
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 10
            maximum: 100
            default: 20
          description: 페이지당 항목 수
        - name: role
          in: query
          required: false
          schema:
            type: string
            enum: [anonymous, user, moderator, admin]
          description: 역할 필터
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [active, suspended, deleted]
          description: 상태 필터
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: 이메일 검색 (부분 일치)
        - name: sortBy
          in: query
          required: false
          schema:
            type: string
            enum: [createdAt, lastLoginAt, email]
            default: createdAt
          description: 정렬 기준
        - name: sortOrder
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: 정렬 순서
      responses:
        '200':
          description: 사용자 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      users:
                        type: array
                        items:
                          $ref: '#/components/schemas/AdminUserInfo'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/users/{userId}:
    get:
      tags:
        - admin-users
      summary: 사용자 상세 조회
      description: |
        특정 사용자의 상세 정보를 조회합니다.

        **Returns**:
        - 기본 정보 (email, role, status, emailVerified)
        - OAuth 연결 정보
        - MFA 활성화 여부
        - 세션 정보 (최근 5개)
        - Audit log (최근 10개)
      operationId: getUserDetails
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: 사용자 상세 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/AdminUserDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - admin-users
      summary: 사용자 정보 수정
      description: |
        특정 사용자의 정보를 수정합니다.

        **Modifiable Fields**:
        - role (역할 변경)
        - status (계정 정지/활성화)
        - emailVerified (이메일 인증 강제 설정)

        **Business Rules**:
        - 자기 자신의 role/status는 변경 불가
        - role 변경: Audit log 기록 (CRITICAL severity)
        - status 변경:
          - suspended → 모든 세션 무효화
          - active (복구) → Audit log 기록
      operationId: updateUser
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                  enum: [user, moderator, admin]
                  example: moderator
                  description: 새 역할 (anonymous 할당 불가)
                status:
                  type: string
                  enum: [active, suspended]
                  example: suspended
                  description: 새 상태 (deleted는 불가, 사용자 직접 삭제만 허용)
                emailVerified:
                  type: boolean
                  example: true
                  description: 이메일 인증 강제 설정
      responses:
        '200':
          description: 사용자 정보 수정 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 사용자 정보가 수정되었습니다.
                  data:
                    $ref: '#/components/schemas/AdminUserInfo'
        '400':
          description: 자기 자신 수정 시도 또는 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                selfModification:
                  value:
                    success: false
                    error:
                      code: CANNOT_MODIFY_SELF
                      message: 자기 자신의 역할이나 상태는 변경할 수 없습니다.
                invalidRole:
                  value:
                    success: false
                    error:
                      code: INVALID_ROLE
                      message: anonymous 역할은 할당할 수 없습니다.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/users/{userId}/sessions:
    get:
      tags:
        - admin-users
      summary: 사용자 세션 목록 조회
      description: |
        특정 사용자의 모든 세션을 조회합니다.

        **Returns**: 활성/비활성 세션 목록
      operationId: getUserSessions
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: includeExpired
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: true일 경우 만료된 세션 포함
      responses:
        '200':
          description: 세션 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      sessions:
                        type: array
                        items:
                          $ref: '#/components/schemas/SessionInfo'
                      total:
                        type: integer
                        example: 5
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - admin-users
      summary: 사용자 세션 전체 무효화
      description: |
        특정 사용자의 모든 활성 세션을 무효화합니다.

        **Business Rules**:
        - 모든 Session 레코드 비활성화
        - Redis 세션 삭제
        - Audit log 기록 (CRITICAL severity)

        **Use Cases**:
        - 보안 사고 대응
        - 계정 정지 시 자동 호출
      operationId: revokeAllUserSessions
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 세션 무효화 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 사용자의 모든 세션이 무효화되었습니다.
                  data:
                    type: object
                    properties:
                      revokedSessionsCount:
                        type: integer
                        example: 3
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/users/{userId}/force-delete:
    delete:
      tags:
        - admin-users
      summary: 사용자 강제 삭제
      description: |
        특정 사용자를 즉시 물리 삭제합니다.

        **WARNING**: 이 작업은 되돌릴 수 없습니다!

        **Business Rules**:
        - 모든 연관 데이터 CASCADE 삭제:
          - Sessions
          - OAuthConnections
          - MFASettings
          - EmailVerificationTokens
          - PasswordResetTokens
        - AuditLogs만 userId = null로 보존
        - Audit log 기록 (CRITICAL severity)

        **Use Cases**:
        - GDPR 완전 삭제 요청
        - 스팸/악의적 계정 제거
      operationId: forceDeleteUser
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - confirm
              properties:
                confirm:
                  type: boolean
                  example: true
                  description: 삭제 확인 (true 필수)
                reason:
                  type: string
                  maxLength: 500
                  example: GDPR 완전 삭제 요청
                  description: 삭제 사유 (선택, Audit log에 기록)
      responses:
        '200':
          description: 사용자 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 사용자가 영구 삭제되었습니다.
        '400':
          description: 자기 자신 삭제 시도 또는 확인 누락
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                selfDeletion:
                  value:
                    success: false
                    error:
                      code: CANNOT_DELETE_SELF
                      message: 자기 자신을 삭제할 수 없습니다.
                confirmRequired:
                  value:
                    success: false
                    error:
                      code: CONFIRMATION_REQUIRED
                      message: 삭제 확인이 필요합니다. (confirm: true)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================================
  # Audit Log 조회
  # ============================================================

  /admin/audit-logs:
    get:
      tags:
        - admin-audit
      summary: Audit log 목록 조회
      description: |
        전체 Audit log를 조회합니다 (페이지네이션).

        **Query Options**:
        - 사용자 필터 (userId)
        - 액션 필터 (action)
        - 심각도 필터 (severity)
        - 시간 범위 (startDate, endDate)

        **Returns**: Audit log 목록 + 페이지네이션 메타데이터
      operationId: listAuditLogs
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 10
            maximum: 100
            default: 50
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: 사용자 ID 필터
        - name: action
          in: query
          required: false
          schema:
            type: string
            enum: [login, logout, login_failed, password_change, mfa_enable, mfa_disable, role_change, account_suspend, account_delete, oauth_connect, oauth_disconnect, password_reset, email_verify]
          description: 액션 필터
        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [info, warning, critical]
          description: 심각도 필터
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: 시작 시각 (ISO 8601)
          example: 2025-11-01T00:00:00Z
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: 종료 시각 (ISO 8601)
          example: 2025-11-05T23:59:59Z
      responses:
        '200':
          description: Audit log 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      logs:
                        type: array
                        items:
                          $ref: '#/components/schemas/AuditLogEntry'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/audit-logs/{logId}:
    get:
      tags:
        - admin-audit
      summary: Audit log 상세 조회
      description: |
        특정 Audit log의 상세 정보를 조회합니다.

        **Returns**: 전체 metadata 포함
      operationId: getAuditLogDetails
      parameters:
        - name: logId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: 880e8400-e29b-41d4-a716-446655440003
      responses:
        '200':
          description: Audit log 상세 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/AuditLogEntry'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================================
  # 통계 및 대시보드
  # ============================================================

  /admin/stats/users:
    get:
      tags:
        - admin-users
      summary: 사용자 통계 조회
      description: |
        사용자 관련 통계를 조회합니다.

        **Returns**:
        - 전체 사용자 수
        - 역할별 사용자 수
        - 상태별 사용자 수
        - 이메일 인증률
        - MFA 활성화율
        - OAuth 사용률
      operationId: getUserStats
      responses:
        '200':
          description: 통계 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      totalUsers:
                        type: integer
                        example: 1234
                      byRole:
                        type: object
                        properties:
                          user:
                            type: integer
                            example: 1150
                          moderator:
                            type: integer
                            example: 30
                          admin:
                            type: integer
                            example: 4
                      byStatus:
                        type: object
                        properties:
                          active:
                            type: integer
                            example: 1180
                          suspended:
                            type: integer
                            example: 20
                          deleted:
                            type: integer
                            example: 34
                      emailVerificationRate:
                        type: number
                        format: float
                        example: 0.87
                        description: 이메일 인증률 (0.0 ~ 1.0)
                      mfaEnabledRate:
                        type: number
                        format: float
                        example: 0.23
                        description: MFA 활성화율 (0.0 ~ 1.0)
                      oauthUsageRate:
                        type: number
                        format: float
                        example: 0.45
                        description: OAuth 사용률 (0.0 ~ 1.0)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

# ============================================================
# Components
# ============================================================

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: token
      description: JWT 토큰 (HttpOnly cookie)

  schemas:
    AdminUserInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          example: user@example.com
        emailVerified:
          type: boolean
          example: true
        role:
          type: string
          enum: [anonymous, user, moderator, admin]
          example: user
        status:
          type: string
          enum: [active, suspended, deleted]
          example: active
        mfaEnabled:
          type: boolean
          example: false
        oauthConnections:
          type: array
          items:
            type: string
            enum: [google, github]
          example: [google]
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          example: 2025-11-05T10:30:00Z
        lastLoginIp:
          type: string
          nullable: true
          example: 192.168.1.100
        createdAt:
          type: string
          format: date-time
          example: 2025-10-01T08:00:00Z
        deletedAt:
          type: string
          format: date-time
          nullable: true
          example: null

    AdminUserDetails:
      allOf:
        - $ref: '#/components/schemas/AdminUserInfo'
        - type: object
          properties:
            sessions:
              type: array
              items:
                $ref: '#/components/schemas/SessionInfo'
              description: 최근 세션 목록 (최대 5개)
            recentAuditLogs:
              type: array
              items:
                $ref: '#/components/schemas/AuditLogEntry'
              description: 최근 Audit log (최대 10개)
            oauthConnectionDetails:
              type: array
              items:
                $ref: '#/components/schemas/OAuthConnectionInfo'
              description: OAuth 연결 상세 정보

    SessionInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        ipAddress:
          type: string
        deviceInfo:
          type: object
          properties:
            browser:
              type: string
            os:
              type: string
            device:
              type: string
        isActive:
          type: boolean
        revokedAt:
          type: string
          format: date-time
          nullable: true

    OAuthConnectionInfo:
      type: object
      properties:
        provider:
          type: string
          enum: [google, github]
        providerId:
          type: string
        email:
          type: string
          format: email
        connectedAt:
          type: string
          format: date-time

    AuditLogEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 880e8400-e29b-41d4-a716-446655440003
        userId:
          type: string
          format: uuid
          nullable: true
          example: 550e8400-e29b-41d4-a716-446655440000
        userEmail:
          type: string
          format: email
          nullable: true
          example: user@example.com
          description: 사용자 이메일 (조인된 정보)
        action:
          type: string
          enum: [login, logout, login_failed, password_change, mfa_enable, mfa_disable, role_change, account_suspend, account_delete, oauth_connect, oauth_disconnect, password_reset, email_verify]
          example: role_change
        ipAddress:
          type: string
          example: 192.168.1.100
        userAgent:
          type: string
          example: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
        metadata:
          type: object
          additionalProperties: true
          example:
            previousRole: user
            newRole: moderator
            changedBy: admin@readzone.com
        severity:
          type: string
          enum: [info, warning, critical]
          example: critical
        timestamp:
          type: string
          format: date-time
          example: 2025-11-05T12:00:00Z

    Pagination:
      type: object
      properties:
        currentPage:
          type: integer
          example: 1
        totalPages:
          type: integer
          example: 10
        totalItems:
          type: integer
          example: 195
        itemsPerPage:
          type: integer
          example: 20
        hasNextPage:
          type: boolean
          example: true
        hasPreviousPage:
          type: boolean
          example: false

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: FORBIDDEN
            message:
              type: string
              example: 접근 권한이 없습니다.
            details:
              type: object
              additionalProperties: true
              nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: VALIDATION_ERROR
              message: 입력 값이 유효하지 않습니다.

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: 인증이 필요합니다.

    Forbidden:
      description: 권한 없음 (Admin 역할 필요)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: FORBIDDEN
              message: 관리자 권한이 필요합니다.

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: NOT_FOUND
              message: 요청한 리소스를 찾을 수 없습니다.
