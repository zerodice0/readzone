openapi: 3.1.0
info:
  title: ReadZone User Management API
  description: |
    사용자 정보 관리 및 세션 관리 API

    **Features**:
    - 프로필 조회 및 수정
    - 세션 관리 (조회, 삭제)
    - OAuth 연결 관리
    - 계정 삭제 (soft-delete)

    **Authentication**: JWT + Session Hybrid (HttpOnly Cookie)

    **Rate Limiting**: 100회/분 (사용자 기준)
  version: 1.0.0
  contact:
    name: ReadZone API Support
    email: api@readzone.com

servers:
  - url: http://localhost:3000/api/v1
    description: Development server
  - url: https://api.readzone.com/v1
    description: Production server

tags:
  - name: users
    description: 사용자 프로필 관리
  - name: sessions
    description: 세션 관리
  - name: oauth
    description: OAuth 연결 관리

security:
  - cookieAuth: []

paths:
  # ============================================================
  # 사용자 프로필
  # ============================================================

  /users/me:
    get:
      tags:
        - users
      summary: 내 프로필 조회
      description: |
        현재 로그인한 사용자의 프로필 정보를 조회합니다.

        **Returns**:
        - 기본 정보 (email, role, emailVerified)
        - OAuth 연결 정보
        - MFA 활성화 여부
      operationId: getMyProfile
      responses:
        '200':
          description: 프로필 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      tags:
        - users
      summary: 내 프로필 수정
      description: |
        현재 로그인한 사용자의 프로필을 수정합니다.

        **Modifiable Fields**:
        - (현재 버전에서는 email 변경만 지원)

        **Business Rules**:
        - 이메일 변경 시: emailVerified = false, 새 인증 메일 발송
        - Audit log 기록
      operationId: updateMyProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  example: newemail@example.com
                  description: 새 이메일 (변경 시 재인증 필요)
      responses:
        '200':
          description: 프로필 수정 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 프로필이 수정되었습니다. 새 이메일 인증을 진행하세요.
                  data:
                    $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 이메일 중복
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: EMAIL_ALREADY_EXISTS
                  message: 이미 사용 중인 이메일입니다.

  /users/me/delete:
    delete:
      tags:
        - users
      summary: 계정 삭제
      description: |
        현재 로그인한 사용자의 계정을 삭제합니다 (soft-delete).

        **Business Rules**:
        - 비밀번호 재확인 필수
        - Soft-delete: status = 'deleted', deletedAt 설정
        - 30일 유예 기간 후 물리 삭제
        - 모든 활성 세션 무효화
        - Audit log 기록 (CRITICAL severity)

        **Recovery**: 30일 이내 로그인 시도 시 복구 가능 (별도 엔드포인트)
      operationId: deleteMyAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
                - confirm
              properties:
                password:
                  type: string
                  format: password
                  example: SecureP@ss123
                  description: 현재 비밀번호 (보안 확인)
                confirm:
                  type: boolean
                  example: true
                  description: 삭제 확인 (true 필수)
      responses:
        '200':
          description: 계정 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 계정이 삭제되었습니다. 30일 이내 복구 가능합니다.
                  data:
                    type: object
                    properties:
                      deletedAt:
                        type: string
                        format: date-time
                        example: 2025-11-05T12:00:00Z
                      permanentDeleteAt:
                        type: string
                        format: date-time
                        example: 2025-12-05T12:00:00Z
                        description: 영구 삭제 예정 시각
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: 비밀번호 불일치
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: INVALID_PASSWORD
                  message: 비밀번호가 올바르지 않습니다.

  # ============================================================
  # 세션 관리
  # ============================================================

  /users/me/sessions:
    get:
      tags:
        - sessions
      summary: 내 세션 목록 조회
      description: |
        현재 로그인한 사용자의 모든 활성 세션을 조회합니다.

        **Returns**:
        - 세션 ID, 생성 시각, 만료 시각
        - 디바이스 정보 (브라우저, OS, 디바이스 타입)
        - IP 주소
        - 현재 세션 표시 (current: true)
      operationId: getMySessions
      parameters:
        - name: includeExpired
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: true일 경우 만료된 세션 포함
      responses:
        '200':
          description: 세션 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      sessions:
                        type: array
                        items:
                          $ref: '#/components/schemas/SessionInfo'
                      total:
                        type: integer
                        example: 3
                        description: 총 세션 수
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/me/sessions/{sessionId}:
    delete:
      tags:
        - sessions
      summary: 특정 세션 삭제
      description: |
        지정한 세션을 무효화합니다.

        **Business Rules**:
        - 현재 세션은 삭제 불가 (대신 /auth/logout 사용)
        - Session 레코드 비활성화 (isActive = false, revokedAt 설정)
        - Redis 세션 삭제
        - Audit log 기록
      operationId: deleteSession
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
      responses:
        '200':
          description: 세션 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 세션이 삭제되었습니다.
        '400':
          description: 현재 세션 삭제 시도
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: CANNOT_DELETE_CURRENT_SESSION
                  message: 현재 세션은 삭제할 수 없습니다. /auth/logout을 사용하세요.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: 세션을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: SESSION_NOT_FOUND
                  message: 세션을 찾을 수 없습니다.

  # ============================================================
  # OAuth 연결 관리
  # ============================================================

  /users/me/oauth-connections:
    get:
      tags:
        - oauth
      summary: OAuth 연결 목록 조회
      description: |
        현재 로그인한 사용자의 OAuth 연결을 조회합니다.

        **Returns**:
        - 제공자 (google, github)
        - 연결 시각
        - 제공자 이메일
        - (access/refresh token은 반환하지 않음)
      operationId: getMyOAuthConnections
      responses:
        '200':
          description: OAuth 연결 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      connections:
                        type: array
                        items:
                          $ref: '#/components/schemas/OAuthConnectionInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/me/oauth-connections/{provider}:
    delete:
      tags:
        - oauth
      summary: OAuth 연결 해제
      description: |
        지정한 OAuth 제공자와의 연결을 해제합니다.

        **Business Rules**:
        - OAuthConnection 레코드 삭제
        - 단, User 레코드는 유지 (비밀번호 설정 시 계정 유지 가능)
        - OAuth 전용 계정 (passwordHash = null)은 연결 해제 불가
        - Audit log 기록
      operationId: disconnectOAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, github]
          example: google
      responses:
        '200':
          description: OAuth 연결 해제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Google 연결이 해제되었습니다.
        '400':
          description: OAuth 전용 계정
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: CANNOT_DISCONNECT_OAUTH_ONLY_ACCOUNT
                  message: OAuth 전용 계정은 연결을 해제할 수 없습니다. 비밀번호를 먼저 설정하세요.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: OAuth 연결을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error:
                  code: OAUTH_CONNECTION_NOT_FOUND
                  message: 연결된 OAuth 계정이 없습니다.

# ============================================================
# Components
# ============================================================

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: token
      description: JWT 토큰 (HttpOnly cookie)

  schemas:
    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          example: user@example.com
        emailVerified:
          type: boolean
          example: true
        role:
          type: string
          enum: [anonymous, user, moderator, admin]
          example: user
        mfaEnabled:
          type: boolean
          example: false
          description: MFA 활성화 여부
        oauthConnections:
          type: array
          items:
            type: string
            enum: [google, github]
          example: [google]
          description: 연결된 OAuth 제공자 목록
        hasPassword:
          type: boolean
          example: true
          description: 비밀번호 설정 여부 (OAuth 전용 계정 판별)
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          example: 2025-11-05T10:30:00Z
        createdAt:
          type: string
          format: date-time
          example: 2025-10-01T08:00:00Z

    SessionInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        current:
          type: boolean
          example: true
          description: 현재 세션 여부
        createdAt:
          type: string
          format: date-time
          example: 2025-11-05T10:00:00Z
        expiresAt:
          type: string
          format: date-time
          example: 2025-11-06T10:00:00Z
        ipAddress:
          type: string
          example: 192.168.1.100
        deviceInfo:
          type: object
          properties:
            browser:
              type: string
              example: Chrome 120
            os:
              type: string
              example: macOS 14
            device:
              type: string
              example: Desktop
        lastActivityAt:
          type: string
          format: date-time
          example: 2025-11-05T11:30:00Z
          description: 마지막 활동 시각

    OAuthConnectionInfo:
      type: object
      properties:
        provider:
          type: string
          enum: [google, github]
          example: google
        providerId:
          type: string
          example: '1234567890'
          description: 제공자의 user ID
        email:
          type: string
          format: email
          example: user@gmail.com
          description: 제공자에서 받은 이메일
        connectedAt:
          type: string
          format: date-time
          example: 2025-10-15T14:20:00Z
        profile:
          type: object
          properties:
            name:
              type: string
              example: John Doe
              nullable: true
            avatar:
              type: string
              format: uri
              example: https://lh3.googleusercontent.com/...
              nullable: true

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
              example: 입력 값이 유효하지 않습니다.
            details:
              type: object
              additionalProperties: true
              nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: VALIDATION_ERROR
              message: 입력 값이 유효하지 않습니다.

    Unauthorized:
      description: 인증 실패 또는 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: 인증이 필요합니다.

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: NOT_FOUND
              message: 요청한 리소스를 찾을 수 없습니다.
