generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String         @id @default(cuid())
  userid            String         @unique @db.VarChar(30)
  email             String?        @db.VarChar(320)
  primaryEmail      String?        @db.VarChar(320)
  nickname          String         @db.VarChar(50)
  password          String?        @db.VarChar(255)
  bio               String?        @db.VarChar(500)
  profileImage      String?        @db.VarChar(255)
  isVerified        Boolean        @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpires DateTime?
  privacy           Json?

  // Moderation fields
  role              UserRole       @default(USER)
  isSuspended       Boolean        @default(false)
  suspendedUntil    DateTime?      @db.Timestamptz(6)

  createdAt         DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime       @updatedAt @db.Timestamptz(6)
  accounts          Account[]
  comments          Comment[]
  following         Follow[]       @relation("UserFollowing")
  followers         Follow[]       @relation("UserFollowers")
  likes             Like[]
  sentNotifications Notification[] @relation("NotificationSender")
  notifications     Notification[] @relation("NotificationReceiver")
  refreshTokens     RefreshToken[]
  reviewDrafts      ReviewDraft[]
  reviews           Review[]

  // Settings relationships
  settings            UserSettings?
  notificationSettings NotificationSettings?

  // Moderation relationships
  adminActions        AuditLog[]      @relation("AdminActions")
  reportsMade         Report[]        @relation("ReportsMade")
  reportsReceived     Report[]        @relation("ReportsReceived")
  blocksInitiated     Block[]         @relation("BlocksInitiated")
  blocksReceived      Block[]         @relation("BlocksReceived")
  violations          Violation[]

  @@index([userid])
  @@index([nickname])
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String   @default("email") @db.VarChar(20)
  provider          String   @default("email") @db.VarChar(20)
  providerAccountId String   @db.VarChar(100)
  email             String?  @db.VarChar(320)
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @db.Timestamptz(6)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([email])
  @@map("accounts")
}

model Book {
  id           String        @id @default(cuid())
  isbn         String?       @unique @db.VarChar(20)
  isbn10       String?       @db.VarChar(10)
  isbn13       String?       @db.VarChar(13)
  title        String        @db.VarChar(500)
  author       String        @db.VarChar(200)
  publisher    String?       @db.VarChar(200)
  publishedAt  String?       @db.VarChar(20)
  description  String?
  thumbnail    String?       @db.VarChar(500)
  category     String?       @db.VarChar(100)
  pages        Int?
  source       String        @default("MANUAL") @db.VarChar(20)
  externalId   String?       @db.VarChar(100)
  createdAt    DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6)
  reviewDrafts ReviewDraft[]
  reviews      Review[]

  @@index([isbn10])
  @@index([isbn13])
  @@index([title])
  @@index([author])
  @@index([createdAt(sort: Desc)])
  @@map("books")
}

model Review {
  id            String    @id @default(cuid())
  title         String    @db.VarChar(200)
  content       String
  isRecommended Boolean   @default(true)
  rating        Int?      @default(5)
  tags          String?
  isPublic      Boolean   @default(true)
  status        String    @default("PUBLISHED") @db.VarChar(20)
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)
  userId        String
  bookId        String
  comments      Comment[]
  likes         Like[]
  book          Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([createdAt(sort: Desc)])
  @@index([isPublic, createdAt(sort: Desc)])
  @@map("reviews")
}

model ReviewDraft {
  id            String   @id @default(cuid())
  userId        String
  bookId        String?
  title         String?  @db.VarChar(200)
  contentHtml   String
  isRecommended Boolean?
  visibility    String?  @db.VarChar(20)
  tags          String?
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  book          Book?    @relation(fields: [bookId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("review_drafts")
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  reviewId  String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, reviewId])
  @@map("likes")
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  parentId  String?
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)
  userId    String
  reviewId  String
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  review    Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

model Notification {
  id        String   @id @default(cuid())
  type      String   @db.VarChar(20)
  message   String   @db.VarChar(500)
  isRead    Boolean  @default(false)
  data      String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  userId    String
  senderId  String?
  reviewId  String?
  commentId String?
  sender    User?    @relation("NotificationSender", fields: [senderId], references: [id])
  user      User     @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  jtiHash   String   @unique @db.VarChar(128)
  isRevoked Boolean  @default(false)
  issuedAt  DateTime @default(now()) @db.Timestamptz(6)
  expiresAt DateTime @db.Timestamptz(6)
  userAgent String?  @db.VarChar(255)
  ip        String?  @db.VarChar(64)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model SearchAnalytics {
  id           Int      @id @default(autoincrement())
  query        String
  queryType    String?  @map("query_type") @db.VarChar(20)
  searchType   String?  @map("search_type") @db.VarChar(20)
  resultCount  Int?     @map("result_count")
  durationMs   Int?     @map("duration_ms")
  searchMethod String?  @map("search_method") @db.VarChar(20)
  userId       String?  @map("user_id") @db.VarChar(255)
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([query])
  @@index([createdAt])
  @@index([queryType])
  @@index([searchMethod])
  @@index([userId])
  @@map("search_analytics")
}

model SearchSuggestions {
  id        Int      @id @default(autoincrement())
  text      String   @unique
  category  String?  @db.VarChar(20)
  frequency Int      @default(1)
  lastUsed  DateTime @default(now()) @map("last_used") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([text])
  @@index([frequency(sort: Desc)])
  @@index([category])
  @@map("search_suggestions")
}

model SearchTrends {
  id          Int      @id @default(autoincrement())
  query       String
  searchCount Int      @default(1) @map("search_count")
  date        DateTime @default(now()) @db.Date
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([query, date])
  @@index([date])
  @@index([searchCount(sort: Desc)])
  @@index([query])
  @@map("search_trends")
}

model SearchMetrics {
  id           Int      @id @default(autoincrement())
  metricName   String   @map("metric_name") @db.VarChar(50)
  metricValue  Decimal? @map("metric_value") @db.Decimal(10, 3)
  searchMethod String?  @map("search_method") @db.VarChar(20)
  searchType   String?  @map("search_type") @db.VarChar(20)
  measuredAt   DateTime @default(now()) @map("measured_at") @db.Timestamptz(6)

  @@index([metricName])
  @@index([measuredAt])
  @@index([searchMethod])
  @@map("search_metrics")
}

enum VisibilityLevel {
  PUBLIC
  FOLLOWERS
  PRIVATE
}

enum Theme {
  LIGHT
  DARK
  AUTO
}

enum Language {
  KO
  EN
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum ReportType {
  SPAM
  HARASSMENT
  HATE_SPEECH
  SEXUAL_CONTENT
  VIOLENCE
  OTHER
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportTargetType {
  REVIEW
  COMMENT
  USER
}

enum ViolationType {
  SPAM
  HARASSMENT
  HATE_SPEECH
  INAPPROPRIATE_CONTENT
  COPYRIGHT
  OTHER
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ViolationStatus {
  ACTIVE
  RESOLVED
  APPEALED
  EXPIRED
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 개인정보 보호 설정
  profileVisibility     VisibilityLevel @default(PUBLIC)
  activityVisibility    VisibilityLevel @default(PUBLIC)
  searchable            Boolean         @default(true)
  showEmail             Boolean         @default(false)
  showFollowers         Boolean         @default(true)
  showFollowing         Boolean         @default(true)

  // 서비스 설정
  theme                 Theme           @default(AUTO)
  language              Language        @default(KO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model NotificationSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 기본 알림 설정
  likesEnabled     Boolean @default(true)
  likesEmail       Boolean @default(false)
  likesPush        Boolean @default(true)

  commentsEnabled  Boolean @default(true)
  commentsEmail    Boolean @default(false)
  commentsPush     Boolean @default(true)

  followsEnabled   Boolean @default(true)
  followsEmail     Boolean @default(false)
  followsPush      Boolean @default(true)

  // 방해금지 설정
  quietHoursEnabled Boolean @default(false)
  quietStartTime    String  @default("22:00")
  quietEndTime      String  @default("08:00")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_settings")
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String
  admin      User     @relation("AdminActions", fields: [adminId], references: [id])
  action     String   @db.VarChar(50)
  targetType String   @db.VarChar(20)
  targetId   String   @db.VarChar(100)
  reason     String?  @db.VarChar(500)
  metadata   Json?
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model Report {
  id              String           @id @default(cuid())
  reporterId      String
  reporter        User             @relation("ReportsMade", fields: [reporterId], references: [id])
  reportedUserId  String
  reportedUser    User             @relation("ReportsReceived", fields: [reportedUserId], references: [id])
  targetType      ReportTargetType
  targetId        String           @db.VarChar(100)
  type            ReportType
  reason          String           @db.VarChar(1000)
  status          ReportStatus     @default(PENDING)
  reviewedById    String?
  reviewedAt      DateTime?        @db.Timestamptz(6)
  adminNotes      String?          @db.VarChar(1000)
  createdAt       DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime         @updatedAt @db.Timestamptz(6)

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

model Block {
  id           String   @id @default(cuid())
  blockerId    String
  blocker      User     @relation("BlocksInitiated", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId    String
  blocked      User     @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)
  reason       String?  @db.VarChar(500)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocks")
}

model Violation {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        ViolationType
  severity    ViolationSeverity  @default(MEDIUM)
  status      ViolationStatus    @default(ACTIVE)
  description String             @db.VarChar(1000)
  reportId    String?
  expiresAt   DateTime?          @db.Timestamptz(6)
  resolvedAt  DateTime?          @db.Timestamptz(6)
  createdAt   DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime           @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@index([status])
  @@index([severity])
  @@index([createdAt(sort: Desc)])
  @@map("violations")
}

