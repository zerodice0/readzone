// Prisma Schema for ReadZone User Authentication System
// Database: PostgreSQL 16
// ORM: Prisma 5.x
// Strict TypeScript mode - No any types allowed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core User Entity
// ============================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  emailVerified    Boolean   @default(false)
  emailVerifiedAt  DateTime?
  passwordHash     String?   // Nullable for OAuth-only accounts
  name             String?
  profileImage     String?
  role             UserRole  @default(USER)
  status           UserStatus @default(ACTIVE)
  mfaEnabled       Boolean   @default(false)
  deletedAt        DateTime? // Soft-delete timestamp
  lastLoginAt      DateTime?
  lastLoginIp      String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relationships
  sessions                 Session[]
  oauthConnections         OAuthConnection[]
  mfaSettings              MFASettings?
  auditLogs                AuditLog[]
  emailVerificationTokens  EmailVerificationToken[]
  passwordResetTokens      PasswordResetToken[]

  @@index([email])
  @@index([status, deletedAt])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ANONYMOUS  // Read-only, non-logged-in user
  USER       // Regular user (can write reviews)
  MODERATOR  // Content moderator
  ADMIN      // System administrator
  SUPERADMIN // Super administrator (full access)
}

enum UserStatus {
  ACTIVE     // Active account
  SUSPENDED  // Suspended account (login disabled)
  DELETED    // Marked for deletion (30-day grace period)
}

// ============================================
// Session Management (Hybrid: JWT + Redis)
// ============================================

model Session {
  id                String    @id @default(uuid())
  userId            String
  token             String?   // JWT full string for verification
  refreshToken      String?
  expiresAt         DateTime
  refreshExpiresAt  DateTime?
  ipAddress         String
  userAgent         String
  deviceInfo        Json      // { browser, os, device }
  isActive          Boolean   @default(true)
  revokedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive, expiresAt])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// OAuth Connections
// ============================================

model OAuthConnection {
  id              String        @id @default(uuid())
  userId          String
  provider        OAuthProvider
  providerId      String        // Provider's user ID
  email           String
  accessToken     String?       // Encrypted with AES-256-GCM
  refreshToken    String?       // Encrypted with AES-256-GCM
  tokenExpiresAt  DateTime?
  profile         Json          // Provider profile: { name, avatar, etc. }
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider, email])
  @@map("oauth_connections")
}

enum OAuthProvider {
  GOOGLE
  GITHUB
}

// ============================================
// Multi-Factor Authentication (TOTP)
// ============================================

model MFASettings {
  id           String    @id @default(uuid())
  userId       String    @unique
  enabled      Boolean   @default(false)
  secret       String    // TOTP secret, encrypted with AES-256-GCM
  backupCodes  String[]  // Array of SHA-256 hashed backup codes
  verifiedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_settings")
}

// ============================================
// Audit Logging
// ============================================

model AuditLog {
  id         String        @id @default(uuid())
  userId     String?       // Nullable for system/pre-auth events
  action     AuditAction
  ipAddress  String
  userAgent  String
  metadata   Json?         // Additional context: { reason, before, after, etc. }
  severity   AuditSeverity @default(INFO)
  timestamp  DateTime      @default(now())
  createdAt  DateTime      @default(now())

  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([severity, timestamp])
  @@map("audit_logs")
}

enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_REQUEST_FAILED
  EMAIL_VERIFY
  EMAIL_VERIFY_REQUEST
  PROFILE_UPDATE
  MFA_ENABLE
  MFA_DISABLE
  MFA_VERIFY
  MFA_BACKUP_REGENERATE
  ROLE_CHANGE
  ACCOUNT_SUSPEND
  ACCOUNT_DELETE
  ACCOUNT_FORCE_DELETE
  OAUTH_LOGIN
  OAUTH_CONNECT
  OAUTH_DISCONNECT
}

enum AuditSeverity {
  INFO     // Normal events (login success, logout)
  WARNING  // Attention needed (login failure, password reset)
  MEDIUM   // Moderate importance (profile updates, settings changes)
  CRITICAL // Immediate response (account suspend, role change)
}

// ============================================
// Email Verification Tokens
// ============================================

model EmailVerificationToken {
  id         String    @id @default(uuid())
  userId     String
  token      String    @unique // URL-safe random 32 chars
  expiresAt  DateTime  // Default 24 hours from creation
  usedAt     DateTime?
  ipAddress  String?
  createdAt  DateTime  @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

// ============================================
// Password Reset Tokens
// ============================================

model PasswordResetToken {
  id         String    @id @default(uuid())
  userId     String
  token      String    @unique // URL-safe random 32 chars
  expiresAt  DateTime  // Default 1 hour from creation
  usedAt     DateTime?
  ipAddress  String?
  createdAt  DateTime  @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}
