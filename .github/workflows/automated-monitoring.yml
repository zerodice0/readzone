name: ğŸ¤– Automated Monitoring & Intelligence

on:
  schedule:
    # ë§¤ì‹œê°„ ìë™ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'ëª¨ë‹ˆí„°ë§ ìœ í˜•'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - performance
          - security
          - quality
      alert_threshold:
        description: 'ì•Œë¦¼ ì„ê³„ê°’ (0.0-1.0)'
        required: false
        default: '0.7'
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  real-time-performance:
    name: ğŸ“Š Real-time Performance Monitoring
    runs-on: ubuntu-latest
    outputs:
      performance-score: ${{ steps.performance-check.outputs.score }}
      performance-grade: ${{ steps.performance-check.outputs.grade }}
      needs-attention: ${{ steps.performance-check.outputs.needs-attention }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run performance monitoring
        id: performance-check
        run: npx tsx scripts/automated-performance-monitor.ts
        env:
          MONITORING_TYPE: ${{ github.event.inputs.monitoring_type || 'comprehensive' }}
          ALERT_THRESHOLD: ${{ github.event.inputs.alert_threshold || '0.7' }}

      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: automated-performance-report
          path: .performance-reports/
          retention-days: 30

  # ì§€ëŠ¥í˜• í’ˆì§ˆ ë¶„ì„
  intelligent-quality-analysis:
    name: ğŸ§  Intelligent Quality Analysis
    runs-on: ubuntu-latest
    needs: real-time-performance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run intelligent analysis
        run: npx tsx scripts/intelligent-quality-analyzer.ts
        env:
          PERFORMANCE_SCORE: ${{ needs.real-time-performance.outputs.performance-score }}

      - name: Generate quality insights
        run: npx tsx scripts/generate-quality-insights.ts

  # ìë™í™”ëœ ë³´ì•ˆ ìŠ¤ìº”
  automated-security-scan:
    name: ğŸ›¡ï¸ Automated Security Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run automated security scan
        run: npx tsx scripts/automated-security-monitor.ts

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: automated-security-report
          path: security-reports/
          retention-days: 90

  # ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ
  real-time-alerting:
    name: ğŸš¨ Real-time Alert System
    runs-on: ubuntu-latest
    needs: [real-time-performance, intelligent-quality-analysis, automated-security-scan]
    if: ${{ needs.real-time-performance.outputs.needs-attention == 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup notification system
        run: npx tsx scripts/setup-alert-system.ts

      - name: Send performance alerts
        if: ${{ needs.real-time-performance.outputs.performance-score < 0.7 }}
        run: |
          echo "ğŸš¨ Performance Alert: Score below threshold"
          echo "Current Score: ${{ needs.real-time-performance.outputs.performance-score }}"
          echo "Grade: ${{ needs.real-time-performance.outputs.performance-grade }}"

      - name: Create monitoring issue
        uses: actions/github-script@v7
        if: ${{ needs.real-time-performance.outputs.performance-score < 0.6 }}
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Automated Performance Alert - Critical',
              body: `
              ## ìë™ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì•Œë¦¼
              
              **ì„±ëŠ¥ ì ìˆ˜**: ${{ needs.real-time-performance.outputs.performance-score }}
              **ë“±ê¸‰**: ${{ needs.real-time-performance.outputs.performance-grade }}
              **ìƒì„± ì‹œê°„**: ${new Date().toISOString()}
              
              ### ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
              - [ ] ì„±ëŠ¥ ë³‘ëª© ì§€ì  ë¶„ì„
              - [ ] ì½”ë“œ ìµœì í™” ê²€í† 
              - [ ] ì¸í”„ë¼ ìŠ¤ì¼€ì¼ë§ ê³ ë ¤
              
              ### ìë™ ëª¨ë‹ˆí„°ë§ ë°ì´í„°
              - ì›Œí¬í”Œë¡œ ì‹¤í–‰: ${{ github.run_id }}
              - ì»¤ë°‹: ${{ github.sha }}
              - ë¸Œëœì¹˜: ${{ github.ref_name }}
              
              _ì´ ì´ìŠˆëŠ” ìë™í™”ëœ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤._
              `,
              labels: ['automated', 'performance', 'critical']
            });
            console.log('Created issue:', issue.data.number);

  # ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
  update-monitoring-dashboard:
    name: ğŸ“ˆ Update Monitoring Dashboard
    runs-on: ubuntu-latest
    needs: [real-time-performance, intelligent-quality-analysis, automated-security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Update dashboard data
        run: npx tsx scripts/update-monitoring-dashboard.ts
        env:
          PERFORMANCE_SCORE: ${{ needs.real-time-performance.outputs.performance-score }}
          PERFORMANCE_GRADE: ${{ needs.real-time-performance.outputs.performance-grade }}

      - name: Generate monitoring report
        run: npx tsx scripts/generate-monitoring-report.ts

      - name: Commit dashboard updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ¤– Automated monitoring dashboard update'
          file_pattern: 'monitoring-dashboard/ .performance-reports/'
          commit_author: 'Automated Monitoring <monitoring@readzone.dev>'

  # ì§€ëŠ¥í˜• ìë™í™” ì¶”ì²œ
  intelligent-automation:
    name: ğŸ¤– Intelligent Automation Recommendations
    runs-on: ubuntu-latest
    needs: [real-time-performance, intelligent-quality-analysis]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Generate automation recommendations
        run: npx tsx scripts/intelligent-automation-advisor.ts
        env:
          PERFORMANCE_SCORE: ${{ needs.real-time-performance.outputs.performance-score }}

      - name: Create automation PR
        if: hashFiles('automation-recommendations.json') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('automation-recommendations.json')) {
              const recommendations = JSON.parse(fs.readFileSync('automation-recommendations.json', 'utf8'));
              
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ¤– Automated Optimization Recommendations',
                head: 'automation/recommendations-' + Date.now(),
                base: 'main',
                body: `
                ## ìë™í™”ëœ ìµœì í™” ê¶Œì¥ì‚¬í•­
                
                ì´ PRì€ ì§€ëŠ¥í˜• ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ìƒì„±í•œ ìµœì í™” ê¶Œì¥ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤.
                
                ### ê¶Œì¥ì‚¬í•­ ìš”ì•½
                ${recommendations.map(r => `- ${r.type}: ${r.description}`).join('\n')}
                
                ### ì˜ˆìƒ ê°œì„  íš¨ê³¼
                - ì„±ëŠ¥ í–¥ìƒ: ${recommendations.reduce((acc, r) => acc + (r.expectedImprovement || 0), 0)}%
                - ìë™í™” ìˆ˜ì¤€: ${recommendations.filter(r => r.automatable).length}/${recommendations.length} í•­ëª©
                
                _ì´ PRì€ ìë™í™”ëœ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë·° í›„ ì ìš©í•´ì£¼ì„¸ìš”._
                `
              });
            }

  # ëª¨ë‹ˆí„°ë§ ìš”ì•½ ë³´ê³ ì„œ
  monitoring-summary:
    name: ğŸ“‹ Monitoring Summary Report
    runs-on: ubuntu-latest
    needs: [real-time-performance, intelligent-quality-analysis, automated-security-scan, real-time-alerting, update-monitoring-dashboard, intelligent-automation]
    if: always()
    
    steps:
      - name: Generate summary report
        run: |
          echo "## ğŸ¤– ìë™í™”ëœ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ì„±ëŠ¥ ì§€í‘œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„±ëŠ¥ ì ìˆ˜**: ${{ needs.real-time-performance.outputs.performance-score || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë“±ê¸‰**: ${{ needs.real-time-performance.outputs.performance-grade || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì£¼ì˜ í•„ìš”**: ${{ needs.real-time-performance.outputs.needs-attention || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ ì‹¤í–‰ëœ ì‘ì—…" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì§€ëŠ¥í˜• í’ˆì§ˆ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ìë™í™”ëœ ë³´ì•ˆ ìŠ¤ìº”" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì§€ëŠ¥í˜• ìë™í™” ì¶”ì²œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ ë‹¤ìŒ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
          echo "ë‹¤ìŒ ìë™ ëª¨ë‹ˆí„°ë§ì€ 1ì‹œê°„ í›„ì— ì‹¤í–‰ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Phase 4.4: ìë™í™” ê°œì„  ë° ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‘ë™ ì¤‘_" >> $GITHUB_STEP_SUMMARY